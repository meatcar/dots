#!/bin/bash

usage="usage: $0 src dest [blurlevel]"
BLUR_LEVEL=${3:-1}

if [ $# -lt 2 ] || [ $# -gt 3 ]; then
    echo "$usage" >&2
    exit 1
fi

case $1 in 
    -h | --help )
        echo "$usage"
        exit
esac

read -r RES_X RES_Y <<<"$(xdpyinfo \
    | grep dimensions \
    | awk '{print $2}' \
    | awk -Fx '{print $1, $2}')"

geometry="$RES_X"x"$RES_Y"

shrink=$(echo "scale=2; 20 / $BLUR_LEVEL" | bc)
sigma=$(echo "scale=2; 0.6 * $BLUR_LEVEL" | bc)
convert "$1" \
    -filter Gaussian \
    -resize "$shrink%" \
    -define "filter:sigma=$sigma" \
    -resize "${geometry}^" -gravity Center \
    -crop "${geometry}+0+0" +repage \
    -ordered-dither o8x8,16 \
    "$2"

#convert "$1" \
    #-colorspace sRGB \
    #-resize "10%" \
    #-scale "${geometry}^" -gravity Center \
    #-crop "${geometry}+0+0" +repage \
    #"$2"
