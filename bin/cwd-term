#!/bin/bash

# based on i3 thread
# https://faq.i3wm.org/question/150/how-to-launch-a-terminal-from-here/?answer=152#post-id-152

TERMINAL=term

# Get window ID (hexadecimal only)
ID=$(xdpyinfo | grep focus | cut -f4 -d " " | sed 's/[^0-9a-fx]//')
echo "WID $ID" >&2

# Get PID of process whose window this is
PID=$(xprop -id "$ID" | grep -m 1 PID | cut -d " " -f 3)
echo "PID $PID" >&2

# Get last child process (shell, vim, etc)
if [ -n "$PID" ]; then
    CPID=$(pgrep -P "$PID" | tail -n1)
    echo "CPID $CPID" >&2
    if [ -z "$CPID" ]; then
        CPID="$PID"
    fi

    if grep -Ea '^emacs' "/proc/$PID/cmdline"; then
        echo "EMACS"
        DIR=$(emacsclient --eval \
                          '(with-current-buffer (window-buffer (selected-window)) (projectile-project-root))' \
                  | sed 's/^"//' | sed 's/"$//')

    else
        # If we find the working directory, run the command in that directory
        DIR=$(readlink /proc/"$CPID"/cwd)
    fi
    echo "DIR $DIR"
    cd "$DIR" || return
fi

$TERMINAL "$@"
