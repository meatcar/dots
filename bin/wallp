#!/bin/bash
temp="/tmp/wallp"
temp2="/tmp/wallp.$$"
trap "rm -f $temp2" 0 1 2 15

DROPBOX="$HOME/Sync"
WALLFOLDER="$DROPBOX/wallpapers/"
WALLLINK="$HOME/.wallpaper"

refresh() {
    find "$WALLFOLDER" -maxdepth 1 -type f > $temp2
    find "$WALLFOLDER/tiling" -maxdepth 1 -type f >> $temp2
    cat $temp2 | sort -R > $temp
}

if [ ! -e $temp ]; then
    refresh
fi

set_wall() {
    if $(echo "$1" | grep 'tiling/' > /dev/null)
    then
        feh --bg-tile "$1"
    else
        feh --bg-fill "$1"
        blur "$1" "$WALLLINK" &
    fi
}

case $# in
    1)
        case $1 in
            -p) #previous
                cur=`tail -1 $temp`
                cat $temp > $temp2
                echo "$cur" > $temp
                cat $temp2 >> $temp
                sed -i '$d' $temp
                cur=`tail -1 $temp`
                set_wall "$cur"
                ;;
            -r) #refresh
                refresh
                ;;
            -d) #delete from rotation
                cat $temp > $temp2
                sed -i 1d $temp2
                cat $temp2 > $temp
                cur=`head -1 $temp`
                set_wall "$cur"
                ;;
            -n) #next
                cur=`head -1 $temp`
                set_wall "$cur"
                cat $temp > $temp2
                sed -i 1d $temp2
                echo "$cur" >> $temp2
                cat $temp2 > $temp
                ;;
            -h|--help)
                echo "usage: $0 [-r|-d|-n|-p|-h|--help]" >&2
                exit 1
                ;;
            *)
                if [ -f "$1" ]; then
                    set_wall "$1"
                fi
                ;;
        esac 
        ;;
    0)
        tail -n1 "$temp"
        ;;
    *)
        echo "usage: $0 -(p|r|n|d)" >&2
        exit 1
        ;;
esac
